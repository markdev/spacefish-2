<!DOCTYPE html>
<head>
    <style>
        canvas#canvas { background-color: #000; }
        #results li.pass { color: green; }
        #results li.fail { color: red; }
    </style>
    <script src="jquery-1.9.0.min.js"></script>
    <script src="myFunctions.js"></script>
<!--<script src="spaceFishData.js"></script>
    <script src="mark.js"></script>
    <script src="spacefish.js"></script>        -->

</head>
<body>

    <canvas id="canvas" height="700" width="1200">Joo cannot see me!</canvas>

    <ul id="results"></ul>

    <script>
        var Game = function () {
            this.canvas = document.getElementById("canvas");
            this.ctx = canvas.getContext("2d");
            this.bufferCanvas = document.createElement("canvas");
            this.bufferCanvasCtx = this.bufferCanvas.getContext("2d");
            this.bufferCanvasCtx.canvas.width = this.ctx.canvas.width;
            this.bufferCanvasCtx.canvas.height = this.ctx.canvas.height;
       //     this.objects = [];

            this.playerArray = [];


            this.events = [];
            this.score = 0;
            this.lives = 3;
            this.img = {};
            this.imgArray = [
                "AGHeads", "bigBloater", "bigBloaterA", "bigBloaterB", "crabCakesA",
                "crabCakesB", "darkBack", "homingFishA", "homingFishB", "orbbouncy",
                "orbdrill", "orbhellfire", "orbhoming", "orblaser", "orbmega", "orbshock",
                "planetview", "seasky", "sinusoidSwimmerA", "sinusoidSwimmerB", "spaceShip",
                "spaceShipA", "spaceShipB", "spaceShipMegaA", "spaceShipMegaB", "spaceShipShield",
                "spaceShipShieldA", "spaceShipShieldB", "speedyBlueA", "speedyBlueB", "spitFireBulletA",
                "spitFireBulletB", "spitFireFishA", "spitFireFishB", "splitFishBigA", "splitFishBigB",
                "splitFishSmallA", "splitFishSmallB", "startScreen", "theSea", "trippyeyeballs",
                "youLose", "youWin"
            ];
        };

       Game.prototype = {
            loadImage : function loadImage(i) {     // naming this function makes it accessible only for self-reference; it is not globally accessible
                i = (typeof i !== 'undefined') ? i : 0;
                var image = new Image();
                image.src = 'images/' + game.imgArray[i] + '.png';
                image.onload = function(e) {
                    window['game']['img'][game.imgArray[i]] = image;
                    i++;
                    if (i < game.imgArray.length) {
                        loadImage(i);   // see, that was painless
                    } else {
                        // <!-- Move this into a script later
                        window.spaceFishData = {
                            splashScreen : {
                                "type" : "basicSplashScreen",   // Integrate this
                                "background" : "startScreen",
                                "flashText" : { x: 500, y: 600, content: "Click to continue", font: "20pt Arial", color: "white"},
                                "events" : [
                                    {"event" : "mousedown", "action" : function() {game.loadGameLoop("levelOne")}}
                                            ]
                            },
                            levelOne : {
                                "type" : "sideScrollLevel",
                                "background" : "theSea"
                            },
                            secondScreen : {
                                "type" : "basicSplashScreen",
                                "background" : "youWin",
                                "flashText" : { x: 500, y: 600, content: "Click to start over", font: "20pt Arial", color: "white"},
                                "events" : [
                                    {"event" : "mousedown", "action" : function() {game.loadGameLoop("splashScreen")}}
                                            ]
                            }
                        }
                        // --> move this into a script later
                        game.loadGameLoop();
                    }
                };
            },

            removeListeners : function(listener) {
                game.canvas.removeEventListener(listener.event, listener.action);
            },

            addListeners : function(listener) {
                game.canvas.addEventListener(listener.event, listener.action);
            },

            loadGameLoop : function(gameScreen) {
                gameScreen = (typeof gameScreen === "undefined")? "splashScreen" : gameScreen;
                this.gameLoop = new GameLoop(spaceFishData[gameScreen]);

                // remove all the event handlers and empty this.events
                if (this.events.length > 0) {
                    for (var i=0, len=this.events.length-1; i<=len; i++) {
                        game.removeListeners(this.events[0]);
                        this.events.shift();
                    }
                }
                // load this.events and add handlers
                if (this.events.length == 0) {
                    // load from game data
                    if (spaceFishData[gameScreen].hasOwnProperty('events')) {       // TODO: see if these two if/for loops can be refactored
                        for (var i=0; i<=spaceFishData[gameScreen]['events'].length-1; i++) {
                            this.events[this.events.length] = spaceFishData[gameScreen]['events'][i];
                            game.addListeners(this.events[this.events.length-1]);
                        }
                    }
                    // load from level function
                    if (window[spaceFishData[gameScreen].type].hasOwnProperty('events')) {
                        for (var i=0; i<=window[spaceFishData[gameScreen].type].events.length-1; i++) {
                            this.events[this.events.length] = window[spaceFishData[gameScreen].type]['events'][i];
                            game.addListeners(this.events[this.events.length-1]);
                        }
                    }
                }

                // assign members to this.gameLoop from levelData
                for (var key in spaceFishData[gameScreen]) {
                    this.gameLoop[key] = spaceFishData[gameScreen][key];
                }
                extend(this.gameLoop, window[spaceFishData[gameScreen].type]);

                // start this shit
                this.gameLoop.initialize();

                // run the animation loop
                this.gameLoop.animate();
            }
        }

       var GameLoop = function(level) {
            var self = this;
            this.initialize = function() {};
            this.clearScreen = function() {};
            this.update = function() {};
            this.render = function() {};
            this.drawbuffer = function() {
                game.ctx.drawImage(game.bufferCanvas, 0, 0, game.bufferCanvas.width, game.bufferCanvas.height);
            };
            this.animate = function() {
                self.clearScreen();
                self.update();
                self.render();
                self.drawbuffer();
                requestAnimationFrame(self.animate);
            };
       }

       var basicSplashScreen = {
            "clearScreen" : function() {
                game.bufferCanvasCtx.drawImage(window['game']['img'][this.background], 0, 0);
            },
            "update" : function() {
                var d = new Date();
                var n = String(d.getTime());
                if (n.substring(10) > 500) {
                    game.bufferCanvasCtx.font = this.flashText.font;
                    game.bufferCanvasCtx.fillStyle = this.flashText.color;
                    game.bufferCanvasCtx.fillText(this.flashText.content, this.flashText.x, this.flashText.y);
                }
            }
       }

       var sideScrollLevel = {
            "initialize" : function() {
                this.clearObjectArray();
                this.initializeObjectArray();
            },
            "clearObjectArray" : function () {  //TODO: clear the animation loop, it seems like it is still rendering when the screen changes
                game.playerArray = [];
            },
            "initializeObjectArray" : function() {
                game.playerArray[game.playerArray.length] = new SpaceShip();
            },
            "clearScreen" : function() {
                game.bufferCanvasCtx.fillStyle = "black";
                game.bufferCanvasCtx.fillRect(0, 0, game.bufferCanvasCtx.canvas.width, game.bufferCanvasCtx.canvas.height);
            },
            "update" : function() {

            },
            "render" : function() {
                for (var i=0; i<game.playerArray.length; i++) {
                    game.bufferCanvasCtx.drawImage(game['img'][game.playerArray[i].image], game.playerArray[i].x, game.playerArray[i].y, game.playerArray[i].w, game.playerArray[i].h);
                }
            },
            "events" : [
                {"event" : "mousedown", "action" : function() {
                    game.playerArray[0].fire();
                }},
                {"event" : "mousemove", "action" : function(e) {
                    if (typeof game.playerArray[0] !== "undefined") {
                       game.playerArray[0].y = e.pageY;
                    }
                }}
            ]
       }

       var SpaceShip = function () {
           this.x = 0;
           this.y = canvas.height/2;
           this.w = 120;
           this.h = 60;
           this.image = "spaceShipA";
           this.fire = function() {
               alert("bang bang");
           }
       }

        var game = new Game();
        game.loadImage();
    </script>


</body>
</html>
