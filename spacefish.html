<!DOCTYPE html>
<head>
    <style>
        canvas#canvas { background-color: #000; }
        #results li.pass { color: green; }
        #results li.fail { color: red; }
    </style>
    <script src="jquery-1.9.0.min.js"></script>
    <script src="myFunctions.js"></script>
</head>
<body>

<canvas id="canvas" height="700" width="1200">Joo cannot see me!</canvas>

<ul id="results"></ul>

<script>
var Game = function () {
    this.canvas = document.getElementById("canvas");
    this.ctx = canvas.getContext("2d");
    this.bufferCanvas = document.createElement("canvas");
    this.bufferCanvasCtx = this.bufferCanvas.getContext("2d");
    this.bufferCanvasCtx.canvas.width = this.ctx.canvas.width;
    this.bufferCanvasCtx.canvas.height = this.ctx.canvas.height;

    this.intervals = [];

    this.time = 0;
    this.startTime = 0;

    this.currentLevel = "";
    this.events = [];
    this.score = 0;
    this.lives = 3;
    this.img = {};
    this.imgArray = ["AGHeads", "bigBloater", "bigBloaterA", "bigBloaterB", "crabCakesA", "crabCakesB", "darkBack", "homingFishA", "homingFishB", "orbbouncy", "orbdrill", "orbhellfire", "orbhoming", "orblaser", "orbmega", "orbshock", "planetview", "seasky", "sinusoidSwimmerA", "sinusoidSwimmerB", "spaceShip", "spaceShipA", "spaceShipB", "spaceShipMegaA", "spaceShipMegaB", "spaceShipShield", "spaceShipShieldA", "spaceShipShieldB", "speedyBlueA", "speedyBlueB", "spitFireBulletA", "spitFireBulletB", "spitFireFishA", "spitFireFishB", "splitFishBigA", "splitFishBigB", "splitFishSmallA", "splitFishSmallB", "startScreen", "theSea", "trippyeyeballs", "youLose", "youWin"];
};

Game.prototype = {
    loadImage : function loadImage(i) {     // naming this function makes it accessible only for self-reference; it is not globally accessible
        i = (typeof i !== 'undefined') ? i : 0;
        var image = new Image();
        image.src = 'images/' + game.imgArray[i] + '.png';
        image.onload = function(e) {
            window['game']['img'][game.imgArray[i]] = image;
            i++;
            if (i < game.imgArray.length) {
                loadImage(i);   // see, that was painless
            } else {
                // <!-- Move this into a script later
                window.spaceFishData = {
                    splashScreen : {
                        "type" : "basicSplashScreen",   // Integrate this
                        "background" : "startScreen",
                        "flashText" : { x: 500, y: 600, content: "Click to continue", font: "20pt Arial", color: "white"},
                        "events" : [
                            {"event" : "mousedown", "action" : function() {game.loadGameLoop("levelOne");}}
                        ]
                    },
                    levelOne : {
                        "type" : "sideScrollLevel",
                        "background" : "theSea",
                        "timer" : 20,
               //         "opponents" : ["Bill", "Sam", "Luciano", "Homer", "Darren", "Frank", "CrabCakes"]
                        "opponents": ["Bill", "Frank"]
                    },
                    secondScreen : {
                        "type" : "basicSplashScreen",
                        "background" : "youWin",
                        "flashText" : { x: 500, y: 600, content: "Click to start over", font: "20pt Arial", color: "white"},
                        "events" : [
                            {"event" : "mousedown", "action" : function() {game.loadGameLoop("splashScreen");}}
                        ]
                    },
                    loseScreen : {
                        "type" : "basicSplashScreen",
                        "background" : "youLose",
                        "flashText" : { x: 500, y: 600, content: "Click to start over", font: "20pt Arial", color: "white"},
                        "events" : [
                            {"event" : "mousedown", "action" : function() {game.initialize();}}
                        ]
                    }
                }
                // --> move this into a script later
                game.initialize();
            }
        };
    },

    initialize : function() {
        game.lives = 3;
        game.gameLoop = new GameLoop("nullScreen");           // TODO: This is a hideous solution to not being able to call game.gameLoop.cancelAnimationFrame conditionally
        game.loadGameLoop("splashScreen");
    },

    removeListeners : function(listener) {
        game.canvas.removeEventListener(listener.event, listener.action);
    },

    addListeners : function(listener) {
        game.canvas.addEventListener(listener.event, listener.action);
    },

    loadGameLoop : function(gameScreen) {
        // start gameLoop
        game.gameLoop.cancelAnimationFrame = true;          // TODO: find a way to do this conditionally, without having to load the null screen
        var gameScreen = (typeof gameScreen === "undefined")? "splashScreen" : gameScreen;
        game.currentLevel = gameScreen;
        var d = new Date();
        var n = String(d.getTime());
        game.startTime = n.substring(10);
        this.gameLoop = new GameLoop(spaceFishData[gameScreen]);

        // remove all the event handlers and empty this.events
        if (this.events.length > 0) {
            for (var i=0, len=this.events.length-1; i<=len; i++) {
                game.removeListeners(this.events[0]);
                this.events.shift();
            }
        }
        // load this.events and add handlers
        if (this.events.length == 0) {
            // load from game data
            if (spaceFishData[gameScreen].hasOwnProperty('events')) {       // TODO: see if these two if/for loops can be refactored
                for (var i=0; i<=spaceFishData[gameScreen]['events'].length-1; i++) {
                    this.events[this.events.length] = spaceFishData[gameScreen]['events'][i];
                    game.addListeners(this.events[this.events.length-1]);
                }
            }
            // load from level function
            if (window[spaceFishData[gameScreen].type].hasOwnProperty('events')) {
                for (var i=0; i<=window[spaceFishData[gameScreen].type].events.length-1; i++) {
                    this.events[this.events.length] = window[spaceFishData[gameScreen].type]['events'][i];
                    game.addListeners(this.events[this.events.length-1]);
                }
            }
        }

        // assign members to this.gameLoop from levelData
        for (var key in spaceFishData[gameScreen]) {
            this.gameLoop[key] = spaceFishData[gameScreen][key];
        }
        extend(this.gameLoop, window[spaceFishData[gameScreen].type]);

        // clear all the existing intervals
        if (typeof game.intervals[0] !== 'undefined') {
            for (var i=0; i<=game.intervals.length-1; i++) {
                clearInterval(game.intervals[i]);
            }
        }

        // start this shit
        this.gameLoop.initialize();

        // run the animation loop
        this.gameLoop.animate();
    }
}

var GameLoop = function(level) {
    var self = this;
    this.cancelAnimationFrame = false;
    this.initialize = function() {};
    this.clearScreen = function() {};
    this.update = function() {};
    this.render = function() {};
    this.drawbuffer = function() {
        game.ctx.drawImage(game.bufferCanvas, 0, 0, game.bufferCanvas.width, game.bufferCanvas.height);
    };
    this.animate = function(time) {
        game.time = time;
        self.clearScreen();
        self.update();
        self.render();
        self.drawbuffer();
        if (self.cancelAnimationFrame == false) {
            requestAnimationFrame(self.animate);
        }
    };
}

/*
 *    GameLoop Level Types
 *
 */
var nullScreen = {};

var basicSplashScreen = {
    "clearScreen" : function() {
        game.bufferCanvasCtx.drawImage(window['game']['img'][this.background], 0, 0);
    },
    "update" : function() {
        var d = new Date();
        var n = String(d.getTime());
        if (n.substring(10) > 500) {
            game.bufferCanvasCtx.font = this.flashText.font;
            game.bufferCanvasCtx.fillStyle = this.flashText.color;
            game.bufferCanvasCtx.fillText(this.flashText.content, this.flashText.x, this.flashText.y);
        }
    }
}

var sideScrollLevel = {
    "initialize" : function() {
        game.playerArray = [];
        game.playerProjectileArray = [];
        game.enemyProjectileArray = [];
        game.opponentArray = [];
        game.itemArray = [];
        game.objectArrays = [
            { "name" : "playerArray", "collidesWith" : "opponentArray", "removal" : function (i) {}},
            { "name" : "playerProjectileArray", "collidesWith" : "opponentArray", "removal" : function (i) {if (game.playerProjectileArray[i].x > canvas.width)  game.playerProjectileArray.splice(i,1);}},
            { "name" : "enemyProjectileArray", "collidesWith" : "playerArray", "removal" : function (i) {if (game.enemyProjectileArray[i].x < 0)  game.enemyProjectileArray.splice(i,1);}},
            { "name" : "opponentArray", "collidesWith" : "playerArray", "removal" : function (i) {if (game.opponentArray[i].x < -(game.opponentArray[i].w)) game.opponentArray.splice(i,1);}},
            { "name" : "itemArray", "collidesWith" : "playerArray", "removal" : function (i) {if (game.itemArray[i].x < -(game.itemArray[i].w)) game.itemArray.splice(i,1);}}
        ];

        game.playerArray[game.playerArray.length] = new sideScrollLevel.Player();
        game.intervals[game.intervals.length] = setInterval(function() {    // Generate opponents at random
            game.opponentArray[game.opponentArray.length] = new sideScrollLevel.Opponent(sideScrollLevel['OpponentData'][spaceFishData[game.currentLevel]['opponents'][Math.floor(Math.random() * spaceFishData[game.currentLevel]['opponents'].length)]]);
        }, 1000);
    },
    "clearScreen" : function() {
        game.bufferCanvasCtx.fillStyle = "black";
        game.bufferCanvasCtx.fillRect(0, 0, game.bufferCanvasCtx.canvas.width, game.bufferCanvasCtx.canvas.height);
    },
    "update" : function() {
        for (var k=0; k<=game.objectArrays.length-1; k++) {
            if (typeof game[game.objectArrays[k].name][0] !== "undefined") {
                for (var i=0; i<=game[game.objectArrays[k].name].length-1; i++) {
                    game[game.objectArrays[k].name][i].update();
                    game[game.objectArrays[k].name][i].detectCollision(i, game.objectArrays[k].collidesWith);
                }
                // Remove blasts from projectileArray when they fly off the screen
                for (var i=0; i<=game[game.objectArrays[k].name].length-1; i++) {
                    game.objectArrays[k].removal(i);
                }
            }
        }
    },
    "render" : function() {
        for (var k=0; k<=game.objectArrays.length-1; k++) {
            if (typeof game[game.objectArrays[k].name] !== "undefined") {
                for (var i=0; i<=game[game.objectArrays[k].name].length-1; i++) {
                    game[game.objectArrays[k].name][i].render(game[game.objectArrays[k].name][i]);
                }
            }
        }
        // render time // TODO make this sensible
        game.bufferCanvasCtx.font = "20pt Arial";
        game.bufferCanvasCtx.fillStyle = "white";
        game.bufferCanvasCtx.fillText(String(game.time - game.startTime).substring(0,2), 100, 100);
    },
    "events" : [
        {"event" : "mousedown", "action" : function() {
            sideScrollLevel['WeaponData'][game.playerArray[0].weapon]["fire"]();
        }},
        {"event" : "mousemove", "action" : function(e) {
            if (typeof game.playerArray[0] !== "undefined") {
                game.playerArray[0].y = e.pageY;
            }
        }}
    ],

    /*
     *    Game Object Prototypes        // TODO: Override basic member assignments with an object prototype
     *
     */
    "Player" : function () {
        var self = this;
        this.x = 0;
        this.y = canvas.height/2;
        this.w = 120;
        this.h = 60;
        this.health = 1;
        this.mode = "normal";
        this.image = "spaceShipA";
        this.weapon = "peaShooter";
        this.update = function () {};
        this.render = function (updateObject) {
            game.bufferCanvasCtx.drawImage(game['img'][updateObject.image], updateObject.x, updateObject.y, updateObject.w, updateObject.h);
        };
        this.detectCollision = function(thingA, thingB) {} // TODO: clean this up, christ
        this.getHit = function () {         //TODO: create a more robust, dynamic way of involving items
            if (this.mode == "mega") {
                this.changeMode('normal');
            } else if (this.mode == "drill") {
                // nothing happens!  //TODO: add effect?
            } else if (this.mode == "normal") {
                this.health -= 1;
                self.die();
            }
        };
        this.die = function () {
            game.lives -= 1;
            var levelToLoad = game.lives > 0 ? "levelOne" : "loseScreen";
            game.loadGameLoop(levelToLoad);
        };
        this.changeMode = function(mode) {
            var modes = {
                "normal" : {"mode" : "normal", "h" : 60, "w" : 120, "health" : 1, "image" : "spaceShipA"},
                "mega" : {"mode" : "mega", "h" : 80, "w" : 120, "health" : 2, "image" : "spaceShipMegaA"},
                "drill" : {"mode" : "drill", "h" : 60, "w" : 145, "health" : 1, "image" : "spaceShipShieldA"}
            };
            for (var key in modes[mode]) {
                if (modes[mode].hasOwnProperty(key)) {
                    self[key] = modes[mode][key];
                }
            }
        }
    },

    "Blast" : function (argData) {
        var self = this;
        this.name = typeof argData.name !== "undefined" ? argData.name : "blast";
        this.x = typeof argData.x !== "undefined" ? argData.x : game.playerArray[0].w;
        this.y = typeof argData.y !== "undefined" ? argData.y : game.playerArray[0].y + game.playerArray[0].h/2;
        this.velx = typeof argData.velx !== "undefined" ? argData.velx : 0;
        this.vely = typeof argData.vely !== "undefined" ? argData.vely : 0;
        this.radius = typeof argData.radius !== "undefined" ? argData.radius : 0;
        this.color = typeof argData.color !== "undefined" ? argData.color : "white";
        this.update = typeof argData.update !== "undefined" ? argData.update : function () {
            this.x += this.velx;
            this.y += this.vely;
        };
        this.render = typeof argData.render !== "undefined" ? argData.render : function (updateObject) {
            game.bufferCanvasCtx.fillStyle = updateObject.color;
            game.bufferCanvasCtx.beginPath();
            game.bufferCanvasCtx.arc(updateObject.x, updateObject.y, updateObject.radius, 0, 2 * Math.PI);
            game.bufferCanvasCtx.fill();
        };
        this.detectCollision = typeof argData.detectCollision !== "undefined" ? argData.detectCollision : function(blastId, targetArray) {
            for (var i=0; i<=game[targetArray].length-1; i++) {
                if (this.x > game[targetArray][i].x && this.x < game[targetArray][i].x + game[targetArray][i].w &&
                        this.y > game[targetArray][i].y && this.y < game[targetArray][i].y + game[targetArray][i].h) {
                    game[targetArray][i].getHit(i);
                    game.playerProjectileArray.splice(blastId,1);
                }
            }
        };
    },

    "Opponent" : function (argData) {   // TODO: add items to opponent directly
        var self = this;
        this.name = argData.name;
        this.w = typeof argData.w !== 'undefined' ? argData.w : 100;
        this.h = typeof argData.h !== 'undefined' ? argData.h : 100;
        this.x = typeof argData.x !== 'undefined' ? argData.x : canvas.width;
        this.y = typeof argData.y !== 'undefined' ? argData.y : Math.random() * (canvas.height - this.h);
        this.velx = typeof velx !== 'undefined' ? velx : argData.velx;
        this.vely = typeof vely !== 'undefined' ? vely : argData.vely;
        this.img = argData.img;
        this.update = typeof argData.update !== "undefined" ? argData.update : function () {};
        this.render = typeof argData.render !== "undefined" ? argData.render : function (updateObject) {
            game.bufferCanvasCtx.drawImage(game['img'][updateObject.img], updateObject.x, updateObject.y, updateObject.w, updateObject.h);
        };
        this.detectCollision = function(opponentId) {
            if (  game.playerArray[0].x + game.playerArray[0].w/2 > game.opponentArray[opponentId].x &&
                    game.playerArray[0].x < game.opponentArray[opponentId].x + game.opponentArray[opponentId].w &&
                    game.playerArray[0].y + game.playerArray[0].h > game.opponentArray[opponentId].y &&
                    game.playerArray[0].y < game.opponentArray[opponentId].y + game.opponentArray[opponentId].h) {
                // Hit Player
                game.playerArray[0].getHit();
                game.opponentArray.splice(opponentId, 1);
            }
        };
        this.getHit = typeof argData.getHit !== 'undefined' ? argData.getHit : function(i) {
            // Generate item by default
            var argData = sideScrollLevel['ItemData'][sideScrollLevel['OpponentData'][self.name]["item"]];
            argData.x = self.x;
            argData.y = self.y + self.h/2;
            game.itemArray[game.itemArray.length] = new sideScrollLevel.Item(argData);
            game.opponentArray.splice(i,1);
        };
    },

    "Item" : function(argData) {  // TODO: make this dynamic so that it is called by the opponent
        var self = this;
        this.name = argData.name;
        this.x = argData.x;
        this.y = argData.y;
        this.w = 40; // TODO: change this to a radius maybe
        this.h = 40;
        this.img = argData.img;
        this.update = function () {
            this.x -= 4;
        };
        this.action = argData.action;
        this.render = function (updateObject) {
            game.bufferCanvasCtx.drawImage(game['img'][updateObject.img], updateObject.x, updateObject.y, updateObject.w, updateObject.h);
        };
        this.detectCollision = function(itemId) {
            if ( game.playerArray[0].x + game.playerArray[0].w/2 > game.itemArray[itemId].x &&
                    game.playerArray[0].x < game.itemArray[itemId].x + game.itemArray[itemId].w &&
                    game.playerArray[0].y + game.playerArray[0].h > game.itemArray[itemId].y &&
                    game.playerArray[0].y < game.itemArray[itemId].y + game.itemArray[itemId].h) {
                // Load the item into the player
                game.itemArray[itemId].action();
                game.itemArray.splice(itemId,1);
            }
        }
    },

    /*
     *    Game Object Data
     *
     */
    "OpponentData" : {
        "Bill" : { "name" : "Bill", "w" : 300, "h" : 150, "velx" : 15, "img" : "bigBloaterA", "item" : "mega", "update" : function() {this.x -= this.velx;}},
        "Sam" : { "name" : "Sam", "w" : 150, "h" : 75, "velx" : 20, "img" : "speedyBlueA", "item" : "dualLaser", "update" : function() {this.x -= this.velx;}},
        "Luciano" : { "name" : "Luciano", "w" : 200, "h" : 300, "velx" : 25, "img" : "sinusoidSwimmerA", "item" : "shockWave", "update" : function() {this.x -= this.velx; var sin = Math.sin(this.x * 2.5) * 80; this.y += sin;}},
        "Homer" : { "name" : "Homer", "w" : 230, "h" : 115, "velx" : 35, "img" : "homingFishA", "item" : "homingMissile", "update" : function() {this.x -= this.velx; this.y += ((this.y + this.h/2) > game.playerArray[0].y)? -10 : 10;}},
        "Darren" : { "name" : "Darren", "w" : 250, "h" : 250, "velx" : 15, "img" : "splitFishBigA", "item" : "dualLaser", "update" : function() {this.x -= this.velx;}, "getHit" : function(i) {                for (var k=-5; k<=5; k+=5){
            var dylanData = sideScrollLevel['OpponentData']['Dylan']; dylanData.x = game.opponentArray[i].x; dylanData.y = game.opponentArray[i].y; dylanData.vely = k;
            game.opponentArray[game.opponentArray.length] = new sideScrollLevel.Opponent(dylanData);
        }
            game.opponentArray.splice(i,1);}},
        "Dylan" : { "name" : "Dylan", "w" : 125, "h" : 75, "velx" : 25, "img" : "splitFishSmallA", "item" : "bouncyBalls", "update" : function() {this.x -= this.velx; this.y -= this.vely;}},
        "Frank" : { "name" : "Frank", "w" : 300, "h" : 150, "velx" : 15, "img" : "spitFireFishA", "item" : "drill", "update" : function() {this.x -= this.velx;  if (this.x >700 && this.x < 720) {game.enemyProjectileArray[game.enemyProjectileArray.length] = new sideScrollLevel.Blast({"name" : "Heroin", "x" : this.x, "y" : this.y + this.h/2, "velx" : -20, "vely" : 0, "update" : function () {this.x += this.velx}, "radius" : 10, "color" : "orange"})}}},
        "CrabCakes" : { "name" : "CrabCakes", "w" : 200, "h" : 200, "velx" : 20, "vely" : 4, "img" : "crabCakesA", "item" : "hellFire", "update" : function() {this.x -= this.velx; if (this.x < 0) this.velx = -this.velx; if (this.x + this.w > canvas.width && this.velx < 0) this.velx = -this.velx; this.y -= this.vely; if (this.y < 0) this.vely = -this.vely; if (this.y + this.h > canvas.height && this.vely < 0) this.vely = -this.vely;}}
    },
    "ItemData" : {
        "mega" : {"name" : "Mega", "img" : "orbmega", "action" : function () {game.playerArray[0].changeMode('mega');}},
        "dualLaser" : {"name" : "Dual Laser", "img" : "orblaser", "action" : function () {game.playerArray[0].weapon = "dualLaser";}},
        "shockWave" : {"name" : "Shock Wave", "img" : "orbshock", "action" : function () {game.playerArray[0].weapon = "shockWave";}},
        "homingMissile" : {"name" : "Homing Missile", "img" : "orbhoming", "action" : function () {game.playerArray[0].weapon = "homingMissile";}},
        "bouncyBalls" : {"name" : "Bouncy Balls", "img" : "orbbouncy", "action" : function () {game.playerArray[0].weapon = "bouncyBalls";}},
        "drill" : {"name" : "Drill", "img" : "orbdrill", "action" : function () {game.playerArray[0].changeMode('drill');}},
        "hellFire" : {"name" : "Hell Fire", "img" : "orbhellfire", "action" : function () {game.playerArray[0].weapon = "hellFire";}}
    },
    "WeaponData" : {     // TODO: figure out whether to put this with itemData, not sure yet
        "peaShooter" : {"fire" : function() {game.playerProjectileArray[game.playerProjectileArray.length] = new sideScrollLevel.Blast({"name" : "Placebo", "velx" : 50, "vely" : 1, "radius" : 10, "color" : "white"})}},
        "dualLaser" : {"fire" : function() {game.playerProjectileArray[game.playerProjectileArray.length] = new sideScrollLevel.Blast({"name" : "Speed", "y" : (game.playerArray[0].y + game.playerArray[0].h/2)-15, "velx" : 10, "vely" : 1, "radius" : 7, "color" : "red"}); game.playerProjectileArray[game.playerProjectileArray.length] = new sideScrollLevel.Blast({"name" : "Speed", "y" : (game.playerArray[0].y + game.playerArray[0].h/2)+15, "velx" : 10, "vely" : 1, "radius" : 7, "color" : "red"});}},
        "shockWave" : {"fire" : function() {game.playerProjectileArray[game.playerProjectileArray.length] = new sideScrollLevel.Blast({"name" : "Molly", "velx" : 10, "vely" : 1, "update" : function () {this.x += this.velx; var sin = Math.sin(this.x * 2.5) * 8; this.y += sin;}, "radius" : 10, "color" : "yellow"})}},
        "homingMissile" : {"fire" : function() {game.playerProjectileArray[game.playerProjectileArray.length] = new sideScrollLevel.Blast({"name" : "Coke", "velx" : 5, "vely" : 1, "update" : function () { if (game.opponentArray.length > 0) {this.y += (game.opponentArray[game.opponentArray.length-1].y - this.y) * .05;} this.x += this.velx;}, "radius" : 20, "color" : "red"})}},
        "bouncyBalls" : {"fire" : function() { game.playerProjectileArray[game.playerProjectileArray.length] = new sideScrollLevel.Blast({"name" : "LSD", "velx" : 10, "vely" : Math.round(Math.random()*2 - 1) * 10, "update" : function () {this.x += this.velx; this.y += this.vely; if (this.y < 0) this.vely = -this.vely; if (this.y + this.radius > canvas.height) this.vely = -this.vely;}, "radius" : 10, "color" : "purple"})}},
        "hellFire" : {"fire" : function() {game.playerProjectileArray[game.playerProjectileArray.length] = new sideScrollLevel.Blast({"name" : "Party", "velx" : Math.round(Math.random()*20 - 10), "vely" : Math.round(Math.random()*20 - 10), "update" : function () {this.x += this.velx; if (this.x < 0) this.velx = -this.velx; if (this.x + this.radius > canvas.width && this.velx > 0) this.velx = -this.velx; this.y -= this.vely; if (this.y < 0) this.vely = -this.vely; if (this.y + this.radius > canvas.height && this.vely < 0) this.vely = -this.vely;}, "radius" : 10, "color" : "red"})}}
    }
}
var game = new Game();
game.loadImage();
</script>
</body>
</html>