<!DOCTYPE html>
<head>
    <style>
        canvas#canvas { background-color: #000; }
        #results li.pass { color: green; }
        #results li.fail { color: red; }
    </style>
    <script src="jquery-1.9.0.min.js"></script>
    <script src="myFunctions.js"></script>
<!--<script src="spaceFishData.js"></script>
    <script src="mark.js"></script>
    <script src="spacefish.js"></script>        -->

</head>
<body>

    <canvas id="canvas" height="700" width="1200">Joo cannot see me!</canvas>

    <ul id="results"></ul>

    <script>
        var Game = function () {
            this.canvas = document.getElementById("canvas");
            this.ctx = canvas.getContext("2d");
            this.bufferCanvas = document.createElement("canvas");
            this.bufferCanvasCtx = this.bufferCanvas.getContext("2d");
            this.bufferCanvasCtx.canvas.width = this.ctx.canvas.width;
            this.bufferCanvasCtx.canvas.height = this.ctx.canvas.height;

            this.playerArray = [];
            this.projectileArray = [];
            this.opponentArray = [];

            this.intervals = [];

            this.time = 0;
            this.startTime = 0;

            this.currentLevel = "";
            this.events = [];
            this.score = 0;
            this.lives = 3;
            this.img = {};
            this.imgArray = [
                "AGHeads", "bigBloater", "bigBloaterA", "bigBloaterB", "crabCakesA",
                "crabCakesB", "darkBack", "homingFishA", "homingFishB", "orbbouncy",
                "orbdrill", "orbhellfire", "orbhoming", "orblaser", "orbmega", "orbshock",
                "planetview", "seasky", "sinusoidSwimmerA", "sinusoidSwimmerB", "spaceShip",
                "spaceShipA", "spaceShipB", "spaceShipMegaA", "spaceShipMegaB", "spaceShipShield",
                "spaceShipShieldA", "spaceShipShieldB", "speedyBlueA", "speedyBlueB", "spitFireBulletA",
                "spitFireBulletB", "spitFireFishA", "spitFireFishB", "splitFishBigA", "splitFishBigB",
                "splitFishSmallA", "splitFishSmallB", "startScreen", "theSea", "trippyeyeballs",
                "youLose", "youWin"
            ];
        };

        Game.prototype = {
            loadImage : function loadImage(i) {     // naming this function makes it accessible only for self-reference; it is not globally accessible
                i = (typeof i !== 'undefined') ? i : 0;
                var image = new Image();
                image.src = 'images/' + game.imgArray[i] + '.png';
                image.onload = function(e) {
                    window['game']['img'][game.imgArray[i]] = image;
                    i++;
                    if (i < game.imgArray.length) {
                        loadImage(i);   // see, that was painless
                    } else {
                        // <!-- Move this into a script later
                        window.spaceFishData = {
                            splashScreen : {
                                "type" : "basicSplashScreen",   // Integrate this
                                "background" : "startScreen",
                                "flashText" : { x: 500, y: 600, content: "Click to continue", font: "20pt Arial", color: "white"},
                                "events" : [
                                    {"event" : "mousedown", "action" : function() {game.loadGameLoop("levelOne");}}
                                            ]
                            },
                            levelOne : {
                                "type" : "sideScrollLevel",
                                "background" : "theSea",
                                "timer" : 20,
                                "opponents" : ["Bill", "Sam"]
                            },
                            secondScreen : {
                                "type" : "basicSplashScreen",
                                "background" : "youWin",
                                "flashText" : { x: 500, y: 600, content: "Click to start over", font: "20pt Arial", color: "white"},
                                "events" : [
                                    {"event" : "mousedown", "action" : function() {game.loadGameLoop("splashScreen");}}
                                            ]
                            },
                            loseScreen : {
                                "type" : "basicSplashScreen",
                                "background" : "youLose",
                                "flashText" : { x: 500, y: 600, content: "Click to start over", font: "20pt Arial", color: "white"},
                                "events" : [
                                    {"event" : "mousedown", "action" : function() {game.initialize();}}
                                ]
                            }
                        }
                        // --> move this into a script later
                        game.initialize();
                    }
                };
            },

            initialize : function() {
                game.lives = 3;
                game.gameLoop = new GameLoop("nullScreen");           // TODO: This is a hideous solution to not being able to call game.gameLoop.cancelAnimationFrame conditionally
                game.loadGameLoop("splashScreen");
            },

            removeListeners : function(listener) {
                game.canvas.removeEventListener(listener.event, listener.action);
            },

            addListeners : function(listener) {
                game.canvas.addEventListener(listener.event, listener.action);
            },

            loadGameLoop : function(gameScreen) {
                // start gameLoop
                game.gameLoop.cancelAnimationFrame = true;          // TODO: find a way to do this conditionally, without having to load the null screen
                var gameScreen = (typeof gameScreen === "undefined")? "splashScreen" : gameScreen;
                game.currentLevel = gameScreen;
                var d = new Date();
                var n = String(d.getTime());
                game.startTime = n.substring(10);
                this.gameLoop = new GameLoop(spaceFishData[gameScreen]);

                // remove all the event handlers and empty this.events
                if (this.events.length > 0) {
                    for (var i=0, len=this.events.length-1; i<=len; i++) {
                        game.removeListeners(this.events[0]);
                        this.events.shift();
                    }
                }
                // load this.events and add handlers
                if (this.events.length == 0) {
                    // load from game data
                    if (spaceFishData[gameScreen].hasOwnProperty('events')) {       // TODO: see if these two if/for loops can be refactored
                        for (var i=0; i<=spaceFishData[gameScreen]['events'].length-1; i++) {
                            this.events[this.events.length] = spaceFishData[gameScreen]['events'][i];
                            game.addListeners(this.events[this.events.length-1]);
                        }
                    }
                    // load from level function
                    if (window[spaceFishData[gameScreen].type].hasOwnProperty('events')) {
                        for (var i=0; i<=window[spaceFishData[gameScreen].type].events.length-1; i++) {
                            this.events[this.events.length] = window[spaceFishData[gameScreen].type]['events'][i];
                            game.addListeners(this.events[this.events.length-1]);
                        }
                    }
                }

                // assign members to this.gameLoop from levelData
                for (var key in spaceFishData[gameScreen]) {
                    this.gameLoop[key] = spaceFishData[gameScreen][key];
                }
                extend(this.gameLoop, window[spaceFishData[gameScreen].type]);

                // clear all the existing intervals
                if (typeof game.intervals[0] !== 'undefined') {
                    for (var i=0; i<=game.intervals.length-1; i++) {
                        clearInterval(game.intervals[i]);
                    }
                }

                // start this shit
                this.gameLoop.initialize();

                // run the animation loop
                this.gameLoop.animate();
            }
        }

       var GameLoop = function(level) {
            var self = this;
            this.cancelAnimationFrame = false;
            this.initialize = function() {};
            this.clearScreen = function() {};
            this.update = function() {};
            this.render = function() {};
            this.drawbuffer = function() {
                game.ctx.drawImage(game.bufferCanvas, 0, 0, game.bufferCanvas.width, game.bufferCanvas.height);
            };
            this.animate = function(time) {
                game.time = time;
                self.clearScreen();
                self.update();
                self.render();
                self.drawbuffer();
       //         console.log(time);
                if (self.cancelAnimationFrame == false) {
                    requestAnimationFrame(self.animate);
                }
            };
       }

       /*
       *    GameLoop Level Types
       *
        */
       var nullScreen = {};

       var basicSplashScreen = {
            "clearScreen" : function() {
                game.bufferCanvasCtx.drawImage(window['game']['img'][this.background], 0, 0);
            },
            "update" : function() {
                var d = new Date();
                var n = String(d.getTime());
                if (n.substring(10) > 500) {
                    game.bufferCanvasCtx.font = this.flashText.font;
                    game.bufferCanvasCtx.fillStyle = this.flashText.color;
                    game.bufferCanvasCtx.fillText(this.flashText.content, this.flashText.x, this.flashText.y);
                }
            }
       }

       var sideScrollLevel = {
            "initialize" : function() {
                game.playerArray = [];
                game.projectileArray = [];
                game.opponentArray = [];
                game.itemArray = [];
                game.playerArray[game.playerArray.length] = new sideScrollLevel.SpaceShip();
                game.intervals[game.intervals.length] = setInterval(this.generateOpponent, 1000);
            },
            "generateOpponent" : function () {
                var opponentName = spaceFishData[game.currentLevel]['opponents'][Math.floor(Math.random() * spaceFishData[game.currentLevel]['opponents'].length)];
                game.opponentArray[game.opponentArray.length] = new sideScrollLevel.Opponent(sideScrollLevel['OpponentData'][opponentName]);
            },
            "generateItem" : function (opponentName, x, y) {
                game.itemArray[game.itemArray.length] = new sideScrollLevel.Item(opponentName, x, y);
                //console.log(game.itemArray);
            },
            "clearScreen" : function() {
                game.bufferCanvasCtx.fillStyle = "black";
                game.bufferCanvasCtx.fillRect(0, 0, game.bufferCanvasCtx.canvas.width, game.bufferCanvasCtx.canvas.height);
            },
            "update" : function() {  // TODO: see if these functions can be refactored
                // Projectiles
                if (typeof game.projectileArray[0] !== "undefined") {
                    for (var i=0; i<=game.projectileArray.length-1; i++) {
                        game.projectileArray[i].update();
                        game.projectileArray[i].detectCollision(i);
                    }
                    // Remove blasts from projectileArray when they fly off the screen
                    for (var i=0; i<=game.projectileArray.length-1; i++) {
                        if (game.projectileArray[i].x > canvas.width)  game.projectileArray.splice(i,1);
                    }
                }
                // Opponents
                if (typeof game.opponentArray[0] !== "undefined") {
                    for (var i=0; i<=game.opponentArray.length-1; i++) {
                        game.opponentArray[i].update();
                        game.opponentArray[i].detectCollision(i);
                    }
                    // Remove opponents that have flown off the screen
                    for (var i=0; i<=game.opponentArray.length-1; i++) {
                        if (game.opponentArray[i].x < -(game.opponentArray[i].w)) game.opponentArray.splice(i,1);
                    }
                }
                // Items
                if (typeof game.itemArray[0] !== "undefined") {
                    for (var i=0; i<=game.itemArray.length-1; i++) {
                        game.itemArray[i].update();
                    }
                    // Remove opponents that have flown off the screen
                    for (var i=0; i<=game.itemArray.length-1; i++) {
                        if (game.itemArray[i].x < 0) game.itemArray.splice(i,1);
                    }
                }
            },
            "render" : function() {
                for (var i=0; i<game.playerArray.length; i++) {
                    game.bufferCanvasCtx.drawImage(game['img'][game.playerArray[i].image], game.playerArray[i].x, game.playerArray[i].y, game.playerArray[i].w, game.playerArray[i].h);
                }
                if (typeof game.projectileArray[0] !== "undefined") {
                    for (var i=0; i<=game.projectileArray.length-1; i++) {
                        game.bufferCanvasCtx.fillStyle = game.projectileArray[i].color;
                        game.bufferCanvasCtx.beginPath();
                        game.bufferCanvasCtx.arc(game.projectileArray[i].x, game.projectileArray[i].y, game.projectileArray[i].radius, 0, 2 * Math.PI);
                        game.bufferCanvasCtx.fill();
                    }
                }
                if (typeof game.opponentArray[0] !== "undefined") {
                    for (var i=0; i<=game.opponentArray.length-1; i++) {
                        game.bufferCanvasCtx.drawImage(game['img'][game.opponentArray[i].img], game.opponentArray[i].x, game.opponentArray[i].y, game.opponentArray[i].w, game.opponentArray[i].h);
                    }
                }
                if (typeof game.itemArray[0] !== "undefined") {
                    for (var i=0; i<=game.itemArray.length-1; i++) {
                        game.bufferCanvasCtx.drawImage(game['img'][game.itemArray[i].img], game.itemArray[i].x, game.itemArray[i].y, 40, 40);
                    }
                }
                console.log(game.itemArray.length);
                // render time // TODO make this sensible
                game.bufferCanvasCtx.font = "20pt Arial";
                game.bufferCanvasCtx.fillStyle = "white";
                game.bufferCanvasCtx.fillText(String(game.time - game.startTime).substring(0,2), 100, 100);
            },
            "events" : [
                {"event" : "mousedown", "action" : function() {
                    sideScrollLevel.fire(game.playerArray[0].weapon);
                }},
                {"event" : "mousemove", "action" : function(e) {
                    if (typeof game.playerArray[0] !== "undefined") {
                       game.playerArray[0].y = e.pageY;
                    }
                }}
            ],
            "fire" : function(weapon) {
               switch(weapon) {
                   case "peaShooter":
                       game.projectileArray[game.projectileArray.length] = new sideScrollLevel.Blast(game.playerArray[0].w, 5, game.playerArray[0].y + game.playerArray[0].h/2, 1, 10, "white", function () {this.x += this.velx});
                       break;
                   case "dualLaser":
                       game.projectileArray[game.projectileArray.length] = new sideScrollLevel.Blast(game.playerArray[0].w, 10, (game.playerArray[0].y + game.playerArray[0].h/2)-15, 1, 7, "red", function () {this.x += this.velx});
                       game.projectileArray[game.projectileArray.length] = new sideScrollLevel.Blast(game.playerArray[0].w, 10, (game.playerArray[0].y + game.playerArray[0].h/2)+15, 1, 7, "red", function () {this.x += this.velx});
                       break;
                   default:
                       break;
               }
            },
           "hitSpaceShip" : function(opponentId) {
               sideScrollLevel.killPlayer();
           },
           "killPlayer" : function() {
               game.lives -= 1;
               if (game.lives > 0) {
           //        alert(game.lives + ' lives left');
                   game.loadGameLoop("levelOne");
               } else {
                   game.loadGameLoop("loseScreen");
               }
           },

           /*
            *    Game Object Prototypes
            *
            */
           "SpaceShip" : function () {
               this.x = 0;
               this.y = canvas.height/2;
               this.w = 120;
               this.h = 60;
               this.image = "spaceShipA";
               this.weapon = "dualLaser";
           },

           "Blast" : function (x, velx, y, vely, radius, color, update) {
               this.x = x;
               this.velx = velx;
               this.y = y;
               this.vely = vely;
               this.radius = radius;
               this.color = color;
               this.update = update;
               this.detectCollision = function(blastId) {
                   for (var i=0; i<=game.opponentArray.length-1; i++) {
                       if (this.x > game.opponentArray[i].x && this.x < game.opponentArray[i].x + game.opponentArray[i].w &&
                           this.y > game.opponentArray[i].y && this.y < game.opponentArray[i].y + game.opponentArray[i].h) {
                           sideScrollLevel.generateItem(game.opponentArray[i].name, game.opponentArray[i].x, game.opponentArray[i].y);
                           game.opponentArray.splice(i,1);
                           game.projectileArray.splice(blastId,1);
                       }
                   }
               };
           },

           "Opponent" : function (opponentData) {
               this.name = opponentData.name;
               this.w = opponentData.w;
               this.h = opponentData.h;
               this.velx = opponentData.velx;
               this.x = canvas.width;
               this.y = Math.random() * canvas.height - this.h;
               this.img = opponentData.img;
               this.update = opponentData.update;
               this.detectCollision = function(opponentId) {
                   if (  game.playerArray[0].x + game.playerArray[0].w/2 > game.opponentArray[opponentId].x &&
                         game.playerArray[0].x < game.opponentArray[opponentId].x + game.opponentArray[opponentId].w &&
                         game.playerArray[0].y + game.playerArray[0].h > game.opponentArray[opponentId].y &&
                         game.playerArray[0].y < game.opponentArray[opponentId].y + game.opponentArray[opponentId].h) {
                         sideScrollLevel.hitSpaceShip(opponentId);
                   }
               };
           },

           "Item" : function(name, x, y) {
               this.name = name;
               this.x = x;
               this.y = y;
               this.radius = 20;
               this.img = "orbmega";
               this.update = function () {
                   this.x -= 4;
               };
           },

           /*
           *    Game Object Data
           *
            */
           "OpponentData" : {
               "Bill" : { "name" : "Bill", "w" : 300, "h" : 150, "velx" : 15, "img" : "bigBloaterA", "item" : "mega", "update" : function() {this.x -= this.velx;}},
               "Sam" : { "name" : "Sam", "w" : 150, "h" : 75, "velx" : 20, "img" : "speedyBlueA", "item" : "dualLaser", "update" : function() {this.x -= this.velx;}}
           },

           "ItemData" : {
                "mega" : {"name" : "Mega"}
           }

       }

        var game = new Game();
        game.loadImage();
    </script>

</body>
</html>
